# Render Debugger CI Workflow
# - Runs tests on push/PR to main/develop
# - Publishes to npm when a version tag (v*) is pushed
#
# Requirements: 13.5, 13.6

name: Render Debugger CI

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      fail_on_severity:
        description: 'Fail on severity level'
        required: false
        default: 'critical'
        type: choice
        options:
          - info
          - warning
          - high
          - critical

env:
  NODE_VERSION: '20'
  RENDER_DEBUGGER_VERSION: 'latest'

jobs:
  # Job 1: Run unit and integration tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Run integration tests
        run: npm run test:integration

  # Job 2: Analyze committed traces for performance issues
  analyze-traces:
    name: Analyze Performance Traces
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build render-debugger
        run: npm run build

      - name: Initialize render-debugger
        run: |
          mkdir -p .render-debugger/traces
          mkdir -p .render-debugger/reports

      - name: Analyze committed traces
        id: analyze
        run: |
          # Find all trace files in the repository
          TRACE_FILES=$(find . -name "*.trace.json" -o -name "trace.json" | head -10)
          
          if [ -z "$TRACE_FILES" ]; then
            echo "No trace files found, skipping analysis"
            echo "traces_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "traces_found=true" >> $GITHUB_OUTPUT
          
          # Analyze each trace file
          for trace in $TRACE_FILES; do
            echo "Analyzing: $trace"
            node dist/main.js analyze "$trace" \
              --name "CI-Analysis-$(basename $trace .json)" \
              --json ".render-debugger/reports/$(basename $trace .json)-report.json" \
              || true
          done

      - name: Check for critical issues
        if: steps.analyze.outputs.traces_found == 'true'
        run: |
          FAIL_ON="${{ github.event.inputs.fail_on_severity || 'critical' }}"
          
          # Check each report for issues at or above the threshold
          for report in .render-debugger/reports/*.json; do
            if [ -f "$report" ]; then
              echo "Checking report: $report"
              
              # Use jq to check for critical issues
              CRITICAL_COUNT=$(jq '[.hotspots.layout_thrashing[], .hotspots.gpu_stalls[], .hotspots.long_tasks[]] | length' "$report" 2>/dev/null || echo "0")
              
              if [ "$CRITICAL_COUNT" -gt 0 ]; then
                echo "::warning::Found $CRITICAL_COUNT performance issues in $report"
              fi
            fi
          done

      - name: Upload analysis reports
        if: always() && steps.analyze.outputs.traces_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: render-debugger-reports
          path: .render-debugger/reports/
          retention-days: 30

  # Job 3: Compare traces for regression detection (on PRs)
  compare-traces:
    name: Compare Performance Traces
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Checkout base branch traces
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base-branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build render-debugger
        run: npm run build

      - name: Compare traces
        id: compare
        run: |
          # Find baseline trace
          BASE_TRACE=$(find base-branch -name "baseline.trace.json" | head -1)
          HEAD_TRACE=$(find . -name "baseline.trace.json" -not -path "./base-branch/*" | head -1)
          
          if [ -z "$BASE_TRACE" ] || [ -z "$HEAD_TRACE" ]; then
            echo "Baseline traces not found, skipping comparison"
            echo "comparison_done=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "comparison_done=true" >> $GITHUB_OUTPUT
          
          FAIL_ON="${{ github.event.inputs.fail_on_severity || 'critical' }}"
          
          # Run comparison
          node dist/main.js compare "$BASE_TRACE" "$HEAD_TRACE" \
            --json .render-debugger/reports/comparison.json \
            --fail-on "$FAIL_ON"

      - name: Upload comparison report
        if: always() && steps.compare.outputs.comparison_done == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: render-debugger-comparison
          path: .render-debugger/reports/comparison.json
          retention-days: 30

      - name: Comment on PR with results
        if: steps.compare.outputs.comparison_done == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('.render-debugger/reports/comparison.json', 'utf8'));
              
              let body = '## ðŸ“Š Render Performance Comparison\n\n';
              
              if (report.regressions && report.regressions.length > 0) {
                body += '### âš ï¸ Regressions Detected\n\n';
                body += '| Metric | Base | Head | Change |\n';
                body += '|--------|------|------|--------|\n';
                
                for (const reg of report.regressions.slice(0, 5)) {
                  body += `| ${reg.metric} | ${reg.base} | ${reg.head} | ${reg.change} |\n`;
                }
              }
              
              if (report.improvements && report.improvements.length > 0) {
                body += '\n### âœ… Improvements\n\n';
                body += '| Metric | Base | Head | Change |\n';
                body += '|--------|------|------|--------|\n';
                
                for (const imp of report.improvements.slice(0, 5)) {
                  body += `| ${imp.metric} | ${imp.base} | ${imp.head} | ${imp.change} |\n`;
                }
              }
              
              body += `\n**Impact Score:** ${report.impactScore || 'N/A'}/100\n`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.log('Could not parse comparison report:', error.message);
            }

  # Job 4: Publish to npm (only on version tags)
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          # Check if this version already exists on npm
          if npm view "${PACKAGE_NAME}@${PACKAGE_VERSION}" version 2>/dev/null; then
            echo "âœ… Version ${PACKAGE_VERSION} already published, skipping..."
          else
            echo "ðŸ“¦ Publishing ${PACKAGE_NAME}@${PACKAGE_VERSION}..."
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
